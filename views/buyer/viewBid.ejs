<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>UNITE - Buyer - View Bid(s)</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Another cool thing made with Glitch">
  <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>    
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>  
  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script src="/autocomp.js"></script>
  <script src="/https.js"></script>
  
  <script type="text/javascript">
    $(document).ready(function() {
      var token = $("input[name='_csrf']:first").val();
      
      $.ajax({
              url: "/bidStatuses",
              headers: { "X-CSRF-Token": token },
              datatype: 'jsonp',
              type: "GET",
              scroll: true,
              error: function() {},
              success: function(data) {                
                if(!data || !data.length)
                  return false;                
                
                $('select[id^="statuses_"]')
                  .bind('change', function() {//Difficult DOM jQuery navigation in modals.                  
                  var theVal = $(this).find('option:selected').attr('value');
                  var index = getId($(this).attr('id'));
                  var statusDiv = $(this).parent('div').parent('div').next('div');
                                   
                  ($(this)
                    .parent('div')
                    .prev('div')
                    .find('input[id^="status"]'))
                    .val(theVal);
                  
                  if(theVal == 3) {
                    var amount = $('#price_'+index).val();
                    
                    statusDiv.append('<button type="button" style="float: left; position: center" title="Pay ' + amount + '" class="btn btn-primary" id="purchase_'+index+'">Go to Purchase</button>');
                  } else {
                    statusDiv.find('button[id^="purchase"]').remove();
                    $('#cartList_'+index).find('li').css({"title": "Already ordered!", "border": "2px"});
                  }
                  
                  statusDiv
                      .find('button[id^="updateBidStatus_"]')
                      .removeAttr('disabled');
                });
              
                $('select[id^="statuses_"]')
                  .each(function(index, el) {
                  for(var i in data) {
                    var opt = '<option ' + (i >= 5? 'disabled ' : '') + 'style="word-wrap: break-word; width: 100px" title="' + data[i].name +'" value="' + data[i].value + '">' + data[i].name + '</option>';
                    $(el).append(opt);
                    }
                  
                  //setTimeout(function() {                    
                    var statusInput = $(el)
                      .parent('div')
                      .prev('div')
                      .find('input[id^="status_"]');                   
                    $(el)
                        .find('option[value="' + statusInput.val() + '"]')
                        .attr({'selected': 'selected'});
                  
                    $(el).attr('title', $(this).find('option:selected').text());                  
                 // }, 300);
                });
              }
      });      
      
      if($('.delete').length()) {
        $('.delete').bind('click', function() {          
          var bidId = $(this).attr('id');
          var div1 = $(this).parent('div'), div2 = div1.prev('div');
          
          if(confirm('Are you sure you want to remove this bid from your Buyer Dashboard forever?')) {
            $.ajax({
              url: '/deleteBid',
              type: 'POST',
              headers: { "X-CSRF-Token": token },
              data: {bidId: bidId},
              datatype: 'application/json',
              error: function() {
                alert('Error on AJAX Request!');
              },
              success: function() {
                div2.remove();
                div1.remove();
                alert('Bid removed by buyer!');
              }
            });
          }
        });
      }      
    });
  </script>
</head>

  <body id="<%= supplierId %>" id2="<%= buyerId %>">
    <div class="container">
      <div>  
        <input type="button" class="btn btn-primary" value="Back" onclick="history.go(-1)">
      </div>
      <div class="col-md-12">
        <% let i = 0; if (bids != null && bids.length > 0) { for (bid of bids) { i++; %>
        
        <div>      
          <div class="card mt-4">
            <h5 class="card-header bg-dark text-white">From: <%= bid.buyerName %></h5>
            <div class="card-body">
              <h5 class="card-title">To: <%= bid.supplierName %></h5>
              <div>
                <span>Request: <%= bid.requestName %></span>
              </div>
              <% if(bid.isCancelled == false) { %>
              <button class="btn btn-primary ml-2" style="float: right" data-target="#request_<%= i %>" data-toggle="modal">View Bid Details</button>
              <% } %>
            </div>
          </div>
        </div>
        <% if(bid.isCancelled == true) { %>
          <div class="card mt-4">
            <p>
              This bid was cancelled upon <% if(bid.status == 6) { %> your <% } else { %> Supplier's <% } %> decision. You can remove the bid completely.
            </p>
            <button class="btn btn-primary ml-2 delete" style="float: right" id="<%= bid._id %>">Delete Bid</button>
          </div>
        <% } else { %>
        <!-- Modal window for the new, valid Bid Request -->
        <div class="modal fade" id="request_<%= i %>" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">View Bid Request</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <form method="POST">
                <input type="hidden" name="id" value="<%= bid._id %>">
                <div class="modal-body">
                  <div class="form-group">
                    <label class="text-muted form-text">
                      (*) are required fields.
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Request Name*</label>
                    <input readonly type="text" class="form-control" name="requestName" value="<%= bid.requestName %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Supplier Company*</label>
                    <input readonly type="text" class="form-control" name="supplierName" value="<%= bid.supplierName %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Buyer Organization*</label>
                    <input readonly type="text" class="form-control" name="buyerName" value="<%= bid.buyerName %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Buyer's E-mail Address*</label>
                    <input readonly type="text" class="form-control" name="buyerEmail" value="<%= bid.buyerEmail %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Buyer's E-mail Address*</label>
                    <input readonly type="text" class="form-control" name="supplierEmail" value="<%= bid.supplierEmail %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description (Short*)</label>
                    <input readonly type="text" class="form-control" name="itemDescription" value="<%= bid.itemDescription %>">
                    <input type="hidden" id="products_<%= i %>" value="<%= bid.productsServicesOffered %>">
                    <input type="hidden" id="prices_<%= i %>" value="<%= bid.priceList %>">
                    <input type="hidden" id="quantities_<%= i %>" value="<%= bid.amountList %>">
                  </div>
                  <div class="form-group">
                    <% const re = /:\s|,\s/;
                    const products = bid.productsServicesOffered;
                    const prices = bid.priceList;
                    const amounts = bid.amountList;
                      %>
                    <Code></Code>
                    <label>Products / Services Offered</label>
                    <ul id="cartList_<%= i %>" class="list-group">
                      <% for (h in products) { %>
                      <li class="list-group-item"><%= amounts[h] %>*<%= products[h] %> - <%= prices[h] %> <%= bid.currency %></li>
                      <% } %>
                    </ul>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description (Long)*</label>
                    <textarea disabled class="form-control" name="itemDescriptionLong" value="<%= bid.itemDescriptionLong %>"><%= bid.itemDescriptionLong %></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description URL (Long)</label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">http(s)://</span>
                      </div>
                      <input disabled type="text" class="form-control" aria-describedby="basic-addon3" value="<%= bid.itemDescriptionUrl %>" name="itemDescriptionUrl">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Amount*</label>
                    <input type="hidden" class="form-control" id="amount_<%= i %>" name="theAmount" value="0">
                    <% j = 0; for(h in bid.amountList) {j += bid.amountList[h];} %>
                    <input type="text" title="Total number of items" disabled id="totalAmount_<%= i %>" name="amount" value="<%= j %>">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Delivery Location*</label>
                    <textarea disabled class="form-control" value="<%= bid.deliveryLocation %>" name="deliveryLocation"><%= bid.deliveryLocation %></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Delivery Requirements*</label>
                    <textarea disabled class="form-control" value="<%= bid.deliveryRequirements %>" name="deliveryRequirements"><%= bid.deliveryRequirements %></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Compliance Requirements*</label>
                    <textarea disabled class="form-control" value="<%= bid.complianceRequirements %>" name="complianceRequirements"><%= bid.complianceRequirements %></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Compliance Requirements URL</label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">http(s)://</span>
                      </div>
                      <input disabled type="text" class="form-control" value="<%= bid.complianceRequirementsUrl %>" name="complianceRequirementsUrl" aria-describedby="basic-addon3">
                    </div>
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Other Requirements</label>
                    <textarea disabled class="form-control" value="<%= bid.otherRequirements %>" name="otherRequirements"><%= bid.otherRequirements %></textarea>
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Price</label>
                     <% l = 0; for(m in bid.priceList) {l += bid.priceList[m];} %>
                    <input type="text" title="Total order price" value="<%= l %> <%= bid.currency %>" class="form-control" id="price_<%= i %>" name="price" disabled>
                     <input type="hidden" value="<%= bid.currency %>" id="currency_<%= i %>" name="currency"></span>
                     <input type="hidden" id="defaultPrice_<%= i %>" value="1">
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Status*</label>
                    <input type="hidden" id="status_<%= i %>" class="form-control" name="status" value="<%= bid.status %>">
                  </div>
                  <div class="form-group selectstatus">
                    <select style="width: 100%" id="statuses_<%= i %>">
                    </select>
                  </div>                    
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="buyer" value="<%= bid.buyer %>">
                  <input type="hidden" name="supplier" value="<%= bid.supplier %>">
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <div class="form-group">
                    <h3>Message for Supplier</h3>
                    <br>
                    <label>Type your message below:</label>
                    <textarea name="message" id="message_<%= i %>" class="form-control"></textarea>
                    <br>
                    <input type="hidden" name="from" value="<%= bid.buyer %>">
                    <input type="hidden" name="to" value="<%= bid.supplier %>">
                    <input type="hidden" name="reqId" value="<%= bid._id %>">
                    <input type="hidden" name="reqName" value="<%= bid.requestName %>">
                    <input type="hidden" name="sender" value="<%= bid.buyerName %>">
                    <input type="hidden" name="receiver" value="<%= bid.supplierName %>">
                    <input type="hidden" name="_csrf" id="csrf_<%= i %>" value="<%= csrfToken %>">
                    <button class="btn btn-primary" title="Update status/Send message" disabled type="submit" id="updateBidStatus_<%= i %>">Update Bid & Message Supplier
                    </button>
                    <script type="text/javascript">
                      var index = "<%= i %>";
                      
                      $("#message_"+index).bind('change', function() {
                        $('#updateBidStatus_'+getId($(this).attr('id'))).removeAttr('disabled');
                      });
                      
                      var stripePublicKey = "<%= stripePublicKey %>";
                      var status = $('#status_'+index).val();
                      
                      if($('#status_'+index).val() == 3) {//Ready to pay -> STRIPE in action!
                        var amount = $('#price_'+index).val();//Not to be confused with the number of items!
                        var currency = $('#currency_'+index).val();
                        var from = "<%= bid.supplierName %>",
                        to = "<%= bid.buyerName %>",
                        desc = "<%= bid.requestName %>",
                        emailAddress = "<%= bid.buyerEmail %>";
                        var that = index;
                        
                        $('#message_'+index)
                          .parent('div')
                          .append('<button type="button" style="float: left; position: center" title="Pay ' + amount + '" class="btn btn-primary" id="purchase_'+index+'">Go to Purchase</button>');
						  
						              var stripeHandler = StripeCheckout.configure({
                            key: stripePublicKey,
                            locale: 'en',
                            token: function(token) {
                              fetch('/purchase', {
                                method: 'POST',
                                headers: {
                                  "X-CSRF-Token": $("#csrf_"+index).val(),
                                  'Content-Type': 'application/json',
                                  'Accept': 'application/json'
                                },
                                body: JSON.stringify({
                                  stripeTokenId: token.id,
                                  token: token,
                                  emailAddress: emailAddress,//Buyer's e-mail.
                                  description: "Order - " + desc,
                                  amount: parseInt(amount),
                                  currency: currency
                                })
                              })
                                .then(function(res) {
                                return res.json();
                              })
                                .then((data) => {
                                //if(!data) {//Assert we have success.
                                  $('#purchase_'+that).remove();
                                  $('#status_'+that).val(4);
                                  $('#statuses_'+that).find('option:eq('+4+')').attr('selected', 'selected');
                                  $('#cartList_'+that).find('li').css({"title": "Already ordered!", "border": "2px"});
                                //}
                                });
                              }
                            });
                        
                        $('#purchase_'+index).bind('click', function() {
                          amount = parseInt(amount)*100;
							            stripeHandler.open({
                            amount: amount,
                            currency: currency,
                            emailAddress: emailAddress,
                            description: desc
                          });
                        });
                      } else {
                        $('#purchase_'+index).remove();
                        if(status >= 4) {//Beyond the purchase phase.
                          $('#cartList_'+index).find('li').css({"title": "Already ordered!", "border": "2px"});//Mark them!
                        }
                      }
                    </script>
                  </div>
              </div>
          </form>
     <!-- Buyer=sender, supplier=receiver. -->     
          <div class="container mt-4">
            <div class="form-group">
              <a href="../../../supplier/chat/<%= bid.buyer %>/<%= bid.supplier %>/<%= bid._id %>/<%= bid.requestName %>/<%= bid.supplierName %>/<%= bid.buyerName %>">
                <button title="Chat" class="btn-secondary custom-button">Chat with your supplier</button>
              </a>
            </div>
          </div>
          <div class="container mt-4">
            <div class="form-group">
              <form action="../../../buyer/cancelBid/" method="POST">
                <input type="hidden" name="bidId" value="<%= bid._id %>">
                <input type="hidden" name="requestsName" value="<%= bid.requestName %>">
                <input type="hidden" name="buyersName" value="<%= bid.buyerName %>">
                <input type="hidden" name="suppliersName" value="<%= bid.supplierName %>">
                <input type="hidden" name="buyersEmail" value="<%= bid.buyerEmail %>">
                <input type="hidden" name="suppliersEmail" value="<%= bid.supplierEmail %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" title="Cancel Order" class="btn-secondary custom-button">Cancel your Order</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
        
    <% } } } else { %>
    <p style="font-size: 12pt; font-weight: bold; color: purple">You have not placed any bids to this supplier. If you prefer, you may do so at any time.</p>
    <% } %>
  </div>
  </div>
  </body>
</html>