<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Buyer Dashboard - UNITE</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A cool thing made with Glitch">
  <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <script src="/autocomp.js"></script>
  <script src="/https.js"></script>
  
    <script type="text/javascript">
      $(document).ready(function() {
        var token = $("input[name='_csrf']").val();
       
        $('#amount').bind('change', function() {
          $('#price').val($(this).val() * $('#defaultPrice').val());          
        });
        
        $('#search').autocomplete({
          source: function(req, res) {
            var obj = $(this.element);
            
            $.ajax({
              url: "/capabilityInputAutocomplete",
              headers: { "X-CSRF-Token": token },
              datatype: 'jsonp',
              type: "GET",
              data: req,
              scroll: true,
              success: function(data) {
                res(data);
                autocomp(obj, data, true);
              },
              error: function(err) {
                alert(err);
              }
            });
          },
          minLength: 3
        });
        
        $('.prodInput').autocomplete({
          source: function(req, res) {
            var obj = $(this.element);
            $('.prov').remove();
            req.supplierId = obj.attr('supplierId');
            
            $.ajax({
              url: "/prodServiceAutocomplete",
              headers: { "X-CSRF-Token": token },
              datatype: 'jsonp',
              type: "GET",
              data: req,
              scroll: true,
              success: function(data) {              
                res(data);
                //autocomp(obj, data);                
                var $obj = '<div class="prov"><ul>';
                for(var i in data) {
                  $obj += '<li id="' + data[i].price + '">' + data[i].name + '</li>';
                }
                
                $obj += '</ul><div>';
                $($obj)
                  .insertAfter(obj.parent('div'))
                  .find('li')
                  .click(function() {
                    obj
                      .attr('price', $(this).attr('id'))
                      .val($(this).text());
                    $(this).parent('ul').hide();
                });
              },
              error: function(err) {
                alert(err);
              }
            });
          },
          minLength: 3
        });        
  });    
  </script> 
</head>

<body>
  <% if (success && success.length > 0) { %>
  <script>
    swal({
      title: "Required!",
      text: "Bid requested successfully!",
      icon: "success",
    });
  </script>
  <% } %>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="/buyer">Buyer - UNITE</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/buyer">Dashboard <span class="sr-only">(current)</span></a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/buyer/balance">Balance: â‚¬<%= buyer.balance %>&nbsp;&nbsp;</a>
        </li>
        <li class="nav-item active">
          <a class="btn btn-primary" href="/buyer/profile">Profile</a>
        </li>
        <br>
        <li class="nav-item" style="margin-left: 0px;">
          <a class="btn btn-danger" href="?exit=true">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <br><br>
    <div class="card">
      <h5 class="card-header">Welcome!</h5>
      <div class="card-body">
        <h5 class="card-title">Hello, <%= buyer.organizationName %></h5>
        <p class="card-text">You can send bid requests to suppliers from here.</p>
      </div>
    </div>
  </div>

  <div class="container">
    <form class="my-2 my-lg-2" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
      <input class="form-control mr-sm-2" type="search" id="search" placeholder="Search Capabilites" aria-label="Search"
        name="capabilityInput">
    </form>

    <div>
      <% let i = 0; if (suppliers != null) { for (supplier of suppliers) { i++; %>
      <div class="card mt-4">
        <h5 class="card-header bg-dark text-white"><%= supplier.companyName %></h5>
        <div class="card-body">
          <h5 class="card-title">Contact Name</h5>
          <p class="card-text">Capability Description.</p>
          <button class="btn btn-primary ml-2" style="float: right;" data-target="#request_<%= i %>"
            data-toggle="modal">Request a Bid</button>
          <button class="btn btn-dark" style="float: right;" data-target="#comp_<%= i %>"
            data-toggle="modal">View</button>
        </div>

        <!-- View Button's Modal -->
        <div class="modal fade" id="comp_<%= i %>" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"><%= supplier.companyName %></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>                  
                  <div class="form-group">
                    <label>Email address</label>
                    <input type="email" class="form-control" readonly value="<%= supplier.emailAddress %>"> </div>
                  <div class="form-group">
                    <label>Director's name</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.directorsName %>">
                  </div>
                  <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.contactName %>">
                  </div>
                  <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.title %>">
                  </div>
                  <div class="form-group">
                    <label>Company Registration No</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.companyRegistrationNo %>">
                  </div>
                  <div class="form-group">
                    <label>Registration Company</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.registrationCompany %>"
                      required>
                  </div>
                  <div class="form-group">
                    <label>Company Address</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.companyAddress %>" required>
                  </div>
                  <div class="form-group">
                    <label>Storage Location</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.storageLocation %>">
                  </div>
                  <div class="form-group">
                    <label>Contact Mobile Number</label>
                    <input type="tel" class="form-control" readonly value="<%= supplier.contactMobileNumber %>">
                  </div>
                  <div class="form-group">
                    <label>Country</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.country %>" required>
                  </div>
                  <div class="form-group">
                    <label>Industry</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.industry %>" required>
                  </div>
                  <div class="form-group">
                    <label>Employee Numbers</label>
                    <input type="number" class="form-control" readonly value="<%= supplier.employeeNumbers %>" required>
                  </div>
                  <div class="form-group">
                    <label>Last Year Turnover</label>
                    <input type="money" class="form-control" readonly value="<%= supplier.lastYearTurnover %>" required>
                  </div>
                  <div class="form-group">
                    <label>Website</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.website %>">
                  </div>
                  <div class="form-group">
                    <label>Facebook URL</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.facebookURL %>">
                  </div>
                  <div class="form-group">
                    <label>Instagram URL</label>
                    <input type="text" class="form-control" readonly readonly value="<%= supplier.instagramURL %>">
                  </div>
                  <div class="form-group">
                    <label>Twitter URL</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.twitterURL %>">
                  </div>
                  <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.linkedinURL %>">
                  </div>
                  <div class="form-group">
                    <label>Other Social Media URL</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.otherSocialMediaURL %>">
                  </div>
                  <div class="form-group">
                    <label>Other Social Media URL</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.commodities %>" required>
                  </div>
                  <div class="form-group">
                    <label>Capability Description</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.capabilityDescription %>"
                      required>
                  </div>
                  <div class="form-group">
                    <label>Relevant Experience</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.relevantExperience %>"
                      required>
                  </div>
                  <div class="form-group">
                    <label>Supporting Information</label>
                    <input type="text" class="form-control" readonly value="<%= supplier.supportingInformation %>">
                  </div>

                  <!-- Uploading files field section-->
                  <div class="form-group">
                    <label>Certificates</label>
                    <input type="url" class="form-control" readonly>
                  </div>
                  <div class="form-group">
                    <label>Anti-bribery policy</label>
                    <input type="url" class="form-control" readonly>
                  </div>
                  <div class="form-group">
                    <label>Environment policy</label>
                    <input type="url" class="form-control" readonly>
                  </div>
                  <div class="form-group">
                    <label>Quality management policy</label>
                    <input type="url" class="form-control" readonly>
                  </div>
                  <div class="form-group">
                    <label>Occupational Safety and Health</label>
                    <input type="url" class="form-control" readonly>
                  </div>
                  <div class="form-group">
                    <label>Other relevant files</label>
                    <input type="url" class="form-control" readonly>
                  </div>

                  <!--Mandatory check of agreements -->
                  <div class="form-group">
                    <div class="form-check">
                      <input required disabled class="form-check-input" type="checkbox"
                        <%= !supplier.UNITETermsAndConditions ? "checked" : "" %>>
                      <label class="form-check-label" for="invalidCheck2">
                        UNITE Terms And Conditions
                      </label>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="form-check">
                      <input required disabled class="form-check-input" type="checkbox"
                        <%= supplier.antibriberyAgreement ? "checked" : "" %> readonly>
                      <label class="form-check-label" for="invalidCheck2">
                        Antibribery Agreement
                      </label>
                    </div>
                  </div>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button> </div>
            </div>
          </div>
        </div>

        <!-- Request Button's Modal -->
        <div class="modal fade" id="request_<%= i %>" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">New Bid Request</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <form method="POST">
                <input type="hidden" class="supplierId" value="<%= supplier._id %>">
                <div class="modal-body">
                  <div class="form-group">
                    <label class="text-muted form-text">
                      Please fill in all the required (*) fields.
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Supplier Company</label>
                    <input type="text" class="form-control" value="<%= supplier.companyName %>" readonly>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description (Short)<b>*</b></label>
                    <input type="text" class="form-control" name="itemDescription" required>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Products / Services Offered*</label>
                    <div class="input-group">
                      <input type="text" required class="form-control prodInput" supplierId="<%= supplier._id %>" placeholder="Add Product/Service" id="prodServiceInput_<%= i %>">
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" disabled id="addProdService_<%= i %>">Add</button>
                      </div>
                    </div>
                    <br>
                    <ul class="list-group" id="prodServices_<%= i %>">
                    </ul>
                    <input type="hidden" required id="hiddenProdServicesList_<%= i %>" name="productsServicesOffered" value="">
                    <input type="hidden" required id="amountList_<%= i %>" name="amountList" value="">
                    <input type="hidden" required id="priceList_<%= i %>" name="priceList" value="">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description (Long)*</label>
                    <textarea class="form-control" name="longItemDescription" required></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Item Description URL (Long)</label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">http(s)://</span>
                      </div>
                      <input type="text" class="form-control" aria-describedby="basic-addon3" name="itemDescriptionURL">
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="col-form-label">Amount*</label>
                    <input type="number" class="form-control" id="amount_<%= i %>" name="theAmount" value="0" required>
                    <input type="hidden" id="totalAmount_<%= i %>" name="amount" value="0">
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Delivery Location*</label>
                    <textarea class="form-control" name="deliveryLocation" required></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Delivery Requirements*</label>
                    <textarea class="form-control" name="deliveryRequirements" required></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Compliance Requirements*</label>
                    <textarea class="form-control" name="complianceRequirements" required></textarea>
                  </div>
                  <div class="form-group">
                    <label class="col-form-label">Compliance Requirements URL</label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">http(s)://</span>
                      </div>
                      <input type="text" class="form-control" name="complianceRequirementsURL"
                        aria-describedby="basic-addon3">
                    </div>
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Other Requirements</label>
                    <textarea class="form-control" name="otherRequirements"></textarea>
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Status*</label>
                    <input type="number" id="status_<%= i %>" class="form-control" name="status" min="0" max="6" step="1" value="0" required> 
                  </div>
                   <div class="form-group">
                    <label class="col-form-label">Price</label>
                    <input type="number" class="form-control" id="price_<%= i %>" name="price" value="0" readonly>
                     <span class="form-control" id="currency_<%= i %>" name="currency">EUR</span>
                    <input type="hidden" id="defaultPrice_<%= i %>" value="1">
                  </div>

                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="buyer" value="<%= buyer._id %>">
                  <input type="hidden" name="supplier" value="<%= supplier._id %>">
                  <script type="text/javascript">
                    function limitStatus(e) {
                        var ASCIICode = (e.which) ? e.which : e.keyCode;
                        if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 54)) 
                            return false;
                        return true; 
                    }
                    
                    $('input[id^="status_"]').bind('keypress keyon keyup', function(e) {
                      return limitStatus(e);
                    });
                    
                    $('input[id^="status_"]').change(function(e) {
                      if($(this).val() > 6 || $(this).val() < 0) {
                        $(this).val(0);
                        return false;
                      }
                      
                      var index = "<%= i %>";
                      var price = $('#price_'+index).val();
                      index = parseInt(index);
                      var statusText = '';                      
                      var l = parseInt($(this).val());
                      
                      statusText = l == 0? 'Buyer requested a bid from you. Please send information to buyer.' 
                      : l == 1? 'Waiting for buyer\'s processing.' 
                      : l == 2? 'Buyer wants to buy the product for the price of ' + price + '. Cancel or Accept.' 
                      : l == 3? 'You started the delivery. Wait for confirmation of buyer.' : 
                      l == 4? 'Payment and delivery are done.' : 
                      l == 5? 'You cancelled the request.' : 
                      l == 6? 'Buyer cancelled the request.' : '';
/*
                      switch((l) {
                        case 0:
                          statusText = 'Buyer requested a bid from you. Please send information to buyer.';
                          break;
/*
                        case 1:
                          statusText = "Waiting for buyer's processing.";
                          break;

                        case 2:
                          statusText = 'Buyer wants to buy the product for the price of ' + price + '. Cancel or Accept.';
                          break;

                        case 3:
                          statusText = 'You started the delivery. Wait for confirmation of buyer.';
                          break;

                        case 4:
                          statusText = 'Payment and delivery is done.';
                          break;

                        case 5:
                          statusText = 'You cancelled the request.';
                          break;

                        case 6:
                          statusText = 'Buyer cancelled the request.';
                          break;
                        default:
                          statusText = '0';
                      }*/

                      //alert(statusText);
                      var val = '<div style="color: blue" id="statusText_'+index + '"><p>' + statusText + '</p></div>';
                      if($("#statusText_"+index).length) $("#statusText_"+index).remove();
                      $(val).insertAfter($('#status_'+index).parent('div'));
                    });
                    
                    $('input[id^="prodServiceInput_"]').change(function() {
                      if($(this).val()) {
                        var index = "<%= i %>";
                        $("button[id='addProdService_"+ index +"']").removeAttr('disabled');
                      }
                    });

                    $("button[id^='addProdService_']").click(() => {
                      var index = "<%= i %>";
                      $('input[id="status_'+ index +'"]').trigger('change');
                      index = parseInt(index);
                     
                      var amount = $('#amount_'+index);                      
                        if(amount.val() < 1) {
                          alert('Please select an amount first');
                          return false;
                        }
                        
                        var input = $("#prodServiceInput_"+index);
                        input.attr('price', $('#defaultPrice_'+index).val());
                      
                        var prodInput = $("#hiddenProdServicesList_"+index);
                        var amountInput = $("#amountList_"+index);
                        var priceInput = $("#priceList_"+index);
                      
                        var product = prodInput.val(), quantity = amountInput.val(), price = priceInput.val();
                      
                        var prodList = isJson(product)? (product) : [];
                        var amountList = isJson(quantity)? (quantity) : [];
                        var priceList = isJson(price)? (price) : [];
                      
                        if(input.val() != "") {
                          var addedPrice = parseInt(amount.val()? amount.val() : 0) * parseInt(input.attr('price')? input.attr('price') : 1);
                          var price = parseInt($('#price_'+index).val()) + addedPrice;
                          $('#price_'+index).val(parseInt(price));
                          var elem = (document.getElementById("prodServices_"+index));
                          
                          elem
                            .insertAdjacentHTML("beforeend", "<li class='list-group-item' price='" + addedPrice + "' amount='" + amount.val() + "'><span>" + $("#prodServiceInput_"+index).val() + "</span><span class='rem'>&nbsp;(Remove)</span></li>");
                          elem = $(elem);
                          
                          var prodVal = input.val(), amountVal = amount.val(), priceVal = $('#price_'+index).val();
                          var prods = prodList.val(), qtys = amountList.val(), prices = priceList.val();
                          var bigPrice = amountVal * priceVal;
                          prodList.push(prodVal);
                          amountList.push(amountVal);
                          priceList.push(bigPrice);//The product
                          
                          //prodList.push(prods && prods.length? prods + ',' + prodVal : prodVal);
                          //amountList.push(qtys && qtys.length? qtys + ',' + amountVal : amountVal);
                          //priceList.push(prices && prices.length? prices + ',' + bigPrice : bigPrice);
                          
                          $('#totalAmount_'+index).val(parseInt($('#totalAmount_'+index).val()) + parseInt(amountVal));
                          prodInput.val((prodList));
                          amountInput.val((amountList));
                          priceInput.val((priceList));
                          
                          $('.rem').unbind('click').click(function() {
                            var li = $(this).parent('li');
                            var newIndex = elem.find('li').index(li);
                            prodList.splice(newIndex, 1);
                            amountList.splice(newIndex, 1);
                            priceList.splice(newIndex, 1);
                            var newAmount = parseInt($('#totalAmount_'+index).val()) - parseInt(li.attr('amount'));
                            var newPrice = parseInt($('#price_'+index).val()) - parseInt(li.attr('price'));
                            $('#totalAmount_'+index).val(parseInt(newAmount));
                            $('#price_'+index).val(parseInt(newPrice));
                            li.remove();
                          });
                          
                          $(input).val('');//.removeAttr('price');                         
                        }
                    });
                  </script>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Send request</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div> <% } }%>
    </div>
  </div>
</body>

</html>